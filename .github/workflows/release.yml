name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  # Windows 构建
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
        working-directory: backend
      
      - name: Clean sensitive config
        run: |
          echo '{"refresh_interval":5,"pushplus_token":"","dingtalk_webhook":"","alert_cooldown":300,"ai_provider":"gemini","ai_api_key":"","ai_model":"","ai_proxy":""}' > backend/data/settings.json
          echo '{"stocks":[],"focused_stock":null,"groups":{},"group_list":[]}' > backend/data/stocks.json
          echo '{}' > backend/data/alerts.json
        shell: bash
      
      - name: Build backend exe
        run: pyinstaller --clean --noconfirm build_backend.spec
        working-directory: backend

      - name: Copy backend to frontend resources
        run: |
          mkdir -p frontend/resources
          cp backend/dist/stock-monitor-backend.exe frontend/resources/
          cp -r backend/data frontend/resources/
        shell: bash
      
      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend
      
      - name: Build frontend
        run: npm run build
        working-directory: frontend
      
      - name: Build Electron app (Windows)
        run: npx electron-builder --win --publish never
        working-directory: frontend
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            frontend/release/*.exe
          retention-days: 5

  # macOS 构建
  build-macos:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
        working-directory: backend
      
      - name: Clean sensitive config
        run: |
          echo '{"refresh_interval":5,"pushplus_token":"","dingtalk_webhook":"","alert_cooldown":300,"ai_provider":"gemini","ai_api_key":"","ai_model":"","ai_proxy":""}' > backend/data/settings.json
          echo '{"stocks":[],"focused_stock":null,"groups":{},"group_list":[]}' > backend/data/stocks.json
          echo '{}' > backend/data/alerts.json
      
      - name: Build backend binary
        run: pyinstaller --clean --noconfirm build_backend.spec
        working-directory: backend
      
      - name: Copy backend to frontend resources
        run: |
          mkdir -p frontend/resources
          cp backend/dist/stock-monitor-backend frontend/resources/ || true
          cp -r backend/data frontend/resources/
      
      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend
      
      - name: Build frontend
        run: npm run build
        working-directory: frontend
      
      - name: Build Electron app (macOS)
        run: npx electron-builder --mac --publish never
        working-directory: frontend
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-release
          path: |
            frontend/release/*.dmg
          retention-days: 5


  # Linux 构建
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
        working-directory: backend
      
      - name: Clean sensitive config
        run: |
          echo '{"refresh_interval":5,"pushplus_token":"","dingtalk_webhook":"","alert_cooldown":300,"ai_provider":"gemini","ai_api_key":"","ai_model":"","ai_proxy":""}' > backend/data/settings.json
          echo '{"stocks":[],"focused_stock":null,"groups":{},"group_list":[]}' > backend/data/stocks.json
          echo '{}' > backend/data/alerts.json
      
      - name: Build backend binary
        run: pyinstaller --clean --noconfirm build_backend.spec
        working-directory: backend
      
      - name: Copy backend to frontend resources
        run: |
          mkdir -p frontend/resources
          cp backend/dist/stock-monitor-backend frontend/resources/ || true
          cp -r backend/data frontend/resources/
      
      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend
      
      - name: Build frontend
        run: npm run build
        working-directory: frontend
      
      - name: Build Electron app (Linux)
        run: npx electron-builder --linux --publish never
        working-directory: frontend
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-release
          path: |
            frontend/release/*.AppImage
          retention-days: 5

  # 创建 Release 并上传所有安装包
  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: release/windows
      
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-release
          path: release/macos
      
      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-release
          path: release/linux
      
      - name: List release files
        run: |
          echo "=== Release files ==="
          find release -type f -name "*"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: 股票监控助手 ${{ github.ref_name }}
          body: |
            ## 股票监控助手 ${{ github.ref_name }}
            
            ### 下载说明
            - **Windows**: 下载 `.exe` 文件，双击安装
            - **macOS**: 下载 `.dmg` 文件，拖拽到应用程序文件夹
            - **Linux**: 下载 `.AppImage` 文件，添加执行权限后运行
            
            ### 更新内容
            请查看 [更新日志](https://github.com/${{ github.repository }}/blob/main/README.md)
          files: |
            release/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
